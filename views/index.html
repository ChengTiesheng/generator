<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
 <head> 
  <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org" /> 
  <script src="http://code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script>
  <script src="js/base64.js" type="text/javascript"></script> 
  <title>websokcet test</title> 
 </head> 
 <body> 
<script type = "text/javascript">


$(function() {
    
    $("#submit").click(function(){

        imagename=$("#imagename").val();
        //alert(imagename);
        if (imagename == ""){
          alert("ImageName can not be null!");
          return false;
        }

        dockerfile=$("#dockerfile").val();
        //alert(dockerfile);
        if (dockerfile == ""){
          alert("DockerFile can not be null!");
          return false;
        }

        base64_str = Base64.encode(dockerfile)

        content = '{"imagename":"';
        content += imagename;
        content += '","dockerfile":"';
        content += base64_str;
        content += '"}';

        //alert(content);

	// add HTTP Request
	var submitData = {
		imagename  : imagename,
		dockerfile : base64_str,
	};
	$.post('/buildreq', submitData,
	  function(data) {
		//appendLog($("<div/>").text(data));  
		console.log("from server==========>",data);
		startShow(data);
	});

        return false;
    });
}) 


function appendLog(msg){
	var log = $("#log");	
        var d = log[0]
        var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
	msg.appendTo(log);
	if (doScroll) {
            d.scrollTop = d.scrollHeight - d.clientHeight;
        }
}

var time = 1000;


function getLog(logid){
	$.post('/show', {logid:logid},function(data) {
		appendLog($("<div>"+data+"</div>"));  
		console.log(data);			
		if (data!="---end---"){
			console.log(data+"=========================");
			console.log(data == "---end---");
			
			if (data == ""){
				time = time * 2;
			}else if (data != "" && time > 1000){
				time = time / 2;
			}
			console.log(time);
			window.setTimeout(function(){getLog(logid)},time);
		}		
	});
}

function startShow(logid){
	window.setTimeout(function(){getLog(logid)},100);
}
</script> 
  <h1>Build image screen</h1> 
  <div id="log" style="height: 300px;overflow-y: scroll;border: 1px solid #CCC;"></div> 
  <div> 
   <form> 
    <p>ImageNmae: <input id="imagename" type="text" /></p> 
    <p>DockerFile: </p> 
    <textarea id="dockerfile" rows="10" cols="30"></textarea>
    <button id="submit">Submit</button>
   </form> 
  </div>   
 </body>
</html>
